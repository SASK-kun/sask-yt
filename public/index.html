<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SASK Neo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.prod.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #08080c;
        --card: #12121a;
        --accent: #6366f1;
        --red: #f43f5e;
        --text: #ffffff;
        --border: rgba(255, 255, 255, 0.08);
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Outfit", sans-serif;
        padding-top: 80px;
      }

      .navbar {
        position: fixed;
        top: 0;
        width: 100%;
        height: 70px;
        background: rgba(8, 8, 12, 0.9);
        backdrop-filter: blur(15px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        z-index: 1000;
        border-bottom: 1px solid var(--border);
      }
      .logo {
        font-size: 1.6rem;
        font-weight: 800;
        color: var(--accent);
        text-decoration: none;
        cursor: pointer;
      }

      .search-box {
        flex: 0.5;
        margin: 0 20px;
        display: flex;
      }
      .search-box input {
        width: 100%;
        padding: 10px 20px;
        border-radius: 50px;
        border: 1px solid var(--border);
        background: #11111a;
        color: #fff;
        outline: none;
      }
      .search-box input:focus {
        border-color: var(--accent);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
      }
      .card {
        background: var(--card);
        border-radius: 16px;
        overflow: hidden;
        cursor: pointer;
        transition: 0.3s;
        border: 1px solid transparent;
      }
      .card:hover {
        transform: translateY(-5px);
        border-color: var(--accent);
      }
      .card img {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
      }
      .card-info {
        padding: 15px;
      }
      .v-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 5px;
        height: 2.7rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
      .v-author {
        color: #888;
        font-size: 0.8rem;
      }

      .watch-layout {
        display: flex;
        gap: 30px;
      }
      .main-v {
        flex: 1;
        min-width: 0;
      }
      .video-p {
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }
      .meta-p {
        background: var(--card);
        padding: 25px;
        border-radius: 20px;
        margin-top: 25px;
        border: 1px solid var(--border);
      }
      .side-v {
        width: 380px;
      }

      .btns {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        color: #fff;
        background: #222;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn.active {
        background: var(--accent);
      }
      .btn.dl {
        background: var(--red);
      }

      .side-item {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        padding: 5px;
        border-radius: 12px;
      }
      .side-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .side-item img {
        width: 140px;
        border-radius: 8px;
        aspect-ratio: 16/9;
        object-fit: cover;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .modal-c {
        background: #151520;
        padding: 30px;
        border-radius: 20px;
        width: 350px;
      }
      .input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        background: #000;
        border: 1px solid var(--border);
        color: #fff;
        margin-bottom: 15px;
        display: block;
        box-sizing: border-box;
      }

      @media (max-width: 1000px) {
        .watch-layout {
          flex-direction: column;
        }
        .side-v {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header class="navbar">
        <div class="logo" @click="nav('/')">SASK</div>
        <form class="search-box" @submit.prevent="onSearch">
          <input v-model="q" placeholder="検索..." />
        </form>
        <div>
          <button
            class="btn"
            style="background: none"
            @click="config.music=!config.music; nav('/')"
          >
            <i
              class="ri-mv-fill"
              :style="{color:config.music? 'var(--accent)':'#777'}"
            ></i>
          </button>
          <button class="btn" style="background: none" @click="showS=true">
            <i class="ri-settings-3-fill"></i>
          </button>
        </div>
      </header>

      <router-view :config="config" :key="$route.fullPath"></router-view>

      <div v-if="showS" class="modal" @click.self="showS=false">
        <div class="modal-c">
          <h3>Settings</h3>
          <label>Title</label><input v-model="config.title" class="input" />
          <label>Genre</label><input v-model="config.genre" class="input" />
          <button
            @click="showS=false"
            class="btn"
            style="
              width: 100%;
              justify-content: center;
              background: var(--accent);
            "
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted, watch } = Vue;
      const { createRouter, createWebHistory } = VueRouter;

      const VideoGrid = {
        props: ["videos"],
        template: `
                <div class="grid">
                    <div v-for="v in videos" :key="v.id" class="card" @click="$emit('play', v.id)">
                        <img :src="v.thumbnail">
                        <div class="card-info">
                            <div class="v-title">{{v.title}}</div>
                            <div class="v-author">{{v.channel}}</div>
                        </div>
                    </div>
                </div>`,
      };

      const Home = {
        props: ["config"],
        components: { VideoGrid },
        template: `<div class="container">
                <h2 style="margin-bottom:20px;">{{ config.music ? 'Trending Music' : 'Recommended' }}</h2>
                <VideoGrid :videos="videos" @play="play" />
            </div>`,
        setup(props) {
          const videos = ref([]);
          onMounted(async () => {
            const q = props.config.music
              ? "Popular Music Video JP"
              : props.config.genre;
            const r = await fetch("/api/search?q=" + encodeURIComponent(q));
            const d = await r.json();
            videos.value = d.results;
          });
          return {
            videos,
            play: (id) => (window.location.href = "/watch?v=" + id),
          };
        },
      };

      const Search = {
        components: { VideoGrid },
        template: `<div class="container">
                <h2 style="margin-bottom:20px;">検索結果: {{query}}</h2>
                <VideoGrid :videos="videos" @play="play" />
            </div>`,
        setup() {
          const videos = ref([]);
          const query = ref("");
          onMounted(async () => {
            query.value = new URLSearchParams(window.location.search).get("q");
            const r = await fetch(
              "/api/search?q=" + encodeURIComponent(query.value)
            );
            const d = await r.json();
            videos.value = d.results;
          });
          return {
            videos,
            query,
            play: (id) => (window.location.href = "/watch?v=" + id),
          };
        },
      };

      const Watch = {
        template: `<div class="container watch-layout">
                <div class="main-v">
                    <div class="video-p"><video ref="v" controls autoplay :loop="loop" style="width:100%;height:100%" @ended="onEnd"></video></div>
                    <div class="meta-p">
                        <h2 style="margin:0">{{info.title}}</h2>
                        <div class="btns">
                            <button class="btn" :class="{active:loop}" @click="loop=!loop"><i class="ri-repeat-2-fill"></i> ループ</button>
                            <button class="btn" :class="{active:auto}" @click="auto=!auto"><i class="ri-play-list-add-fill"></i> 自動再生</button>
                            <a :href="'/api/stream?id='+info.id+'&dl=1'" class="btn dl"><i class="ri-download-fill"></i> DL</a>
                        </div>
                        <p style="color:#888">{{info.channel}} • {{info.subscribers}} subs</p>
                        <div style="font-size:0.9rem; color:#aaa; white-space:pre-wrap; max-height:200px; overflow-y:auto">{{info.description}}</div>
                    </div>
                </div>
                <div class="side-v">
                    <h4 style="margin:0 0 15px">次はこちら</h4>
                    <div v-for="r in info.related" :key="r.id" class="side-item" @click="play(r.id)">
                        <img :src="r.thumbnail">
                        <div><div class="v-title" style="height:auto; font-size:0.85rem">{{r.title}}</div><div class="v-author">{{r.channel}}</div></div>
                    </div>
                </div>
            </div>`,
        setup() {
          const v = ref(null);
          const info = ref({ related: [] });
          const loop = ref(false);
          const auto = ref(true);
          onMounted(async () => {
            const id = new URLSearchParams(window.location.search).get("v");
            if (!id) return;
            v.value.src = "/api/stream?id=" + id + "&t=" + Date.now();
            const r = await fetch("/api/info?id=" + id);
            info.value = await r.json();
          });
          const onEnd = () => {
            if (auto.value && info.value.related.length)
              play(info.value.related[0].id);
          };
          const play = (id) => (window.location.href = "/watch?v=" + id);
          return { v, info, loop, auto, onEnd, play };
        },
      };

      const router = createRouter({
        history: createWebHistory(),
        routes: [
          { path: "/", component: Home },
          { path: "/watch", component: Watch },
          { path: "/search", component: Search },
        ],
      });

      createApp({
        setup() {
          const q = ref("");
          const showS = ref(false);
          const config = reactive(
            JSON.parse(
              localStorage.getItem("s_v3_cfg") ||
                '{"title":"SASK Neo","genre":"trending","music":false}'
            )
          );
          watch(
            config,
            (nv) => {
              localStorage.setItem("s_v3_cfg", JSON.stringify(nv));
              document.title = nv.title;
            },
            { deep: true, immediate: true }
          );
          const onSearch = () => {
            if (q.value)
              window.location.href = "/search?q=" + encodeURIComponent(q.value);
          };
          return {
            q,
            showS,
            config,
            onSearch,
            nav: (p) => (window.location.href = p),
          };
        },
      })
        .use(router)
        .mount("#app");
    </script>
  </body>
</html>
